<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <title>OpenClaw å®¶åº­åŠ©æ‰‹ - å¢å¼ºç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 600px;
      height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header p {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .message-area {
      flex: 1;
      background: #f9f9f9;
      padding: 20px;
      overflow-y: auto;
    }
    
    .message {
      margin-bottom: 15px;
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 80%;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user {
      background: #667eea;
      color: white;
      margin-left: auto;
      text-align: right;
    }
    
    .message.assistant {
      background: #f0f0f0;
      color: #333;
    }
    
    .controls {
      padding: 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
    }
    
    button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .input-area {
      padding: 0 20px 20px;
      background: white;
      display: flex;
      gap: 10px;
    }
    
    input[type="text"] {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
    }
    
    input[type="text"]:focus {
      border-color: #667eea;
    }
    
    .send-btn {
      padding: 12px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .send-btn:hover {
      background: #5568d3;
    }
    
    .status-bar {
      background: #f5f5f5;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: #666;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
    }
    
    .status-indicator.connected {
      background: #4CAF50;
    }
    
    .settings-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .settings-panel.show {
      display: flex;
    }
    
    .settings-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
    }
    
    .settings-content h2 {
      margin-bottom: 20px;
      color: #333;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #666;
      font-size: 14px;
    }
    
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .settings-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .settings-actions button {
      flex: 1;
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤– OpenClaw å®¶åº­åŠ©æ‰‹</h1>
      <p>æ¡Œé¢å®¢æˆ·ç«¯ - å¢å¼ºç‰ˆ</p>
    </div>
    
    <div class="status-bar">
      <div class="status-indicator" id="statusIndicator"></div>
      <span id="statusText">æœªè¿æ¥</span>
      <div style="margin-left: auto; display: flex; gap: 10px;">
        <span style="cursor: pointer; color: #667eea;" onclick="showHistory()">ğŸ“œ å†å²</span>
        <span style="cursor: pointer; color: #667eea;" onclick="showSettings()">âš™ï¸ è®¾ç½®</span>
      </div>
    </div>
    
    <div class="message-area" id="messageArea"></div>
    
    <div class="input-area">
      <input type="text" id="textInput" placeholder="è¾“å…¥æ¶ˆæ¯..." />
      <button class="send-btn" onclick="sendMessage()">å‘é€</button>
    </div>
    
    <div class="controls">
      <button class="btn-primary" id="voiceBtn">ğŸ¤ è¯­éŸ³è¾“å…¥ (F2)</button>
      <button class="btn-primary" id="ttsBtn" style="background: #4CAF50;" onclick="toggleTTS()">ğŸ”Š TTS: <span id="ttsStatus">å…³</span></button>
    </div>
  </div>
  
  <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->
  <div class="modal" id="historyModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“œ å¯¹è¯å†å²</h2>
        <button class="close-btn" onclick="hideHistory()">Ã—</button>
      </div>
      <div id="historyList"></div>
    </div>
  </div>
  
  <!-- è®¾ç½®é¢æ¿ -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-content">
      <h2>âš™ï¸ è®¾ç½®</h2>
      <div class="form-group">
        <label>DashScope API Key:</label>
        <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ API å¯†é’¥" />
      </div>
      <div class="form-group">
        <label>å¯¹è¯ä¸Šä¸‹æ–‡é•¿åº¦:</label>
        <select id="contextLength">
          <option value="5">æœ€è¿‘ 5 æ¡</option>
          <option value="10" selected>æœ€è¿‘ 10 æ¡</option>
          <option value="20">æœ€è¿‘ 20 æ¡</option>
        </select>
      </div>
      <div class="form-group">
        <label>TTS è¯­éŸ³:</label>
        <select id="ttsVoice">
          <option value="zh-CN">ä¸­æ–‡</option>
          <option value="en-US">English</option>
        </select>
      </div>
      <div class="settings-actions">
        <button class="btn-secondary" onclick="hideSettings()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="saveSettings()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // å¢å¼ºç‰ˆçŠ¶æ€ç®¡ç†
    const state = {
      apiKey: localStorage.getItem('dashscope_api_key') || '',
      contextLength: parseInt(localStorage.getItem('context_length') || '10'),
      ttsEnabled: localStorage.getItem('tts_enabled') === 'true',
      ttsVoice: localStorage.getItem('tts_voice') || 'zh-CN',
      messages: JSON.parse(localStorage.getItem('chat_history') || '[]'),
      conversationHistory: [],
      isListening: false,
      recognition: null,
      synth: window.speechSynthesis
    };
    
    // åˆå§‹åŒ–
    function init() {
      document.getElementById('apiKey').value = state.apiKey;
      document.getElementById('contextLength').value = state.contextLength;
      document.getElementById('ttsVoice').value = state.ttsVoice;
      updateTTSStatus();
      setupSpeechRecognition();
      loadMessages();
    }
    
    // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'zh-CN';
      recognition.continuous = false;
      
      recognition.onstart = () => {
        isListening = true;
        document.getElementById('voiceBtn').textContent = 'â¹ï¸ åœæ­¢å½•éŸ³';
        document.getElementById('statusIndicator').className = 'status-indicator connected';
        document.getElementById('statusText').textContent = 'æ­£åœ¨å¬...';
      };
      
      recognition.onend = () => {
        isListening = false;
        document.getElementById('voiceBtn').textContent = 'ğŸ¤ è¯­éŸ³è¾“å…¥ (F2)';
        updateStatus(false, 'å·²è¿æ¥');
      };
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        sendMessage(transcript);
      };
      
      recognition.onerror = (event) => {
        addMessage('è¯­éŸ³è¯†åˆ«é”™è¯¯ï¼š' + event.error, 'error');
      };
    }
    
    // TTS è¯­éŸ³åˆæˆ
    function speak(text) {
      if (!state.synth || !state.ttsEnabled) return;
      state.synth.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = state.ttsVoice;
      state.synth.speak(utterance);
    }
    
    function toggleTTS() {
      state.ttsEnabled = !state.ttsEnabled;
      localStorage.setItem('tts_enabled', state.ttsEnabled);
      updateTTSStatus();
    }
    
    function updateTTSStatus() {
      document.getElementById('ttsStatus').textContent = state.ttsEnabled ? 'å¼€' : 'å…³';
    }
    
    // å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F2' && !e.ctrlKey && !e.altKey && !e.metaKey) {
        e.preventDefault();
        toggleVoice();
      }
      if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    function updateStatus(connected, text) {
      const indicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');
      
      if (connected) {
        indicator.className = 'status-indicator connected';
      } else {
        indicator.className = 'status-indicator';
      }
      statusText.textContent = text;
    }
    
    function addMessage(text, type = 'assistant') {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.textContent = text;
      const area = document.getElementById('messageArea');
      area.appendChild(msg);
      area.scrollTop = area.scrollHeight;
    }
    
    function sendMessage(text) {
      const input = document.getElementById('textInput');
      const message = text || input.value.trim();
      if (!message) return;
      
      addMessage(message, 'user');
      input.value = '';
      
      // æ›´æ–°å¯¹è¯å†å²
      state.conversationHistory.push({ role: 'user', content: message });
      if (state.conversationHistory.length > state.contextLength * 2) {
        state.conversationHistory = state.conversationHistory.slice(-state.contextLength * 2);
      }
      
      callDashScopeAPI(message);
    }
    
    async function callDashScopeAPI(userMessage) {
      if (!state.apiKey) {
        addMessage('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API å¯†é’¥', 'error');
        return;
      }
      
      const loadingId = 'msg-' + Date.now();
      addMessage('æ€è€ƒä¸­...', 'assistant');
      
      try {
        const messages = [
          { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªå®¶åº­åŠ©æ‰‹ï¼Œè¯·ç†è§£ç”¨æˆ·çš„è¯­éŸ³æŒ‡ä»¤å¹¶æä¾›ç›¸åº”çš„å¸®åŠ©ã€‚ä¿æŒå¯¹è¯è¿è´¯æ€§ã€‚' },
          ...state.conversationHistory
        ];
        
        const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${state.apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'qwen-max',
            input: { messages },
            parameters: {
              temperature: 0.7,
              top_p: 0.8,
              max_tokens: 500
            }
          })
        });
        
        document.getElementById(loadingId)?.remove();
        const data = await response.json();
        
        if (response.ok && data.output && data.output.choices && data.output.choices[0]) {
          const content = data.output.choices[0].message.content;
          addMessage(content, 'assistant');
          
          // æ›´æ–°å¯¹è¯å†å²
          state.conversationHistory.push({ role: 'assistant', content });
          
          // TTS æœ—è¯»
          if (state.ttsEnabled) {
            speak(content);
          }
        } else {
          addMessage('API é”™è¯¯ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (e) {
        document.getElementById(loadingId)?.remove();
        addMessage('è¯·æ±‚å¤±è´¥ï¼š' + e.message, 'error');
      }
      
      saveMessages();
    }
    
    function toggleVoice() {
      if (!recognition) {
        addMessage('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«', 'error');
        return;
      }
      
      if (isListening) {
        recognition.stop();
      } else {
        recognition.start();
      }
    }
    
    document.getElementById('voiceBtn').addEventListener('click', toggleVoice);
    document.getElementById('textInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    function showSettings() {
      document.getElementById('settingsPanel').classList.add('show');
      document.getElementById('apiKey').value = apiKey;
    }
    
    function hideSettings() {
      document.getElementById('settingsPanel').classList.remove('show');
    }
    
    function saveSettings() {
      state.apiKey = document.getElementById('apiKey').value.trim();
      state.contextLength = parseInt(document.getElementById('contextLength').value);
      state.ttsVoice = document.getElementById('ttsVoice').value;
      
      localStorage.setItem('dashscope_api_key', state.apiKey);
      localStorage.setItem('context_length', state.contextLength);
      localStorage.setItem('tts_voice', state.ttsVoice);
      
      hideSettings();
      addMessage('è®¾ç½®å·²ä¿å­˜', 'assistant');
    }
    
    // æ¶ˆæ¯ç®¡ç†
    function addMessage(content, type) {
      const id = 'msg-' + Date.now();
      const msg = { id, content, type, timestamp: new Date().toISOString() };
      state.messages.push(msg);
      renderMessage(msg);
      saveMessages();
      return id;
    }
    
    function renderMessage(msg) {
      const area = document.getElementById('messageArea');
      const div = document.createElement('div');
      div.className = `message ${msg.type}`;
      div.id = msg.id;
      div.innerHTML = `${msg.content}<div class="timestamp">${new Date(msg.timestamp).toLocaleString('zh-CN')}</div>`;
      area.appendChild(div);
      area.scrollTop = area.scrollHeight;
    }
    
    function loadMessages() {
      const area = document.getElementById('messageArea');
      area.innerHTML = '';
      if (state.messages.length === 0) {
        addMessage('ä½ å¥½ï¼æ”¯æŒè¯­éŸ³ã€TTSã€å¤šè½®å¯¹è¯å’Œå†å²è®°å½•ã€‚F2 è¯­éŸ³ï¼ŒCtrl+Enter å‘é€ã€‚', 'assistant');
      } else {
        state.messages.forEach(renderMessage);
      }
    }
    
    function saveMessages() {
      localStorage.setItem('chat_history', JSON.stringify(state.messages));
    }
    
    // å†å²è®°å½•
    function showHistory() {
      const list = document.getElementById('historyList');
      list.innerHTML = '';
      const grouped = {};
      state.messages.forEach(msg => {
        const date = new Date(msg.timestamp).toLocaleDateString('zh-CN');
        if (!grouped[date]) grouped[date] = [];
        grouped[date].push(msg);
      });
      
      Object.keys(grouped).reverse().forEach(date => {
        const dateDiv = document.createElement('div');
        dateDiv.style.fontWeight = 'bold';
        dateDiv.style.margin = '10px 0 5px';
        dateDiv.textContent = date;
        list.appendChild(dateDiv);
        grouped[date].forEach(msg => {
          const item = document.createElement('div');
          item.className = 'history-item';
          item.innerHTML = `<div class="date">${new Date(msg.timestamp).toLocaleTimeString('zh-CN')} - ${msg.type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div><div class="preview">${msg.content.substring(0, 50)}${msg.content.length > 50 ? '...' : ''}</div>`;
          list.appendChild(item);
        });
      });
      document.getElementById('historyModal').classList.add('show');
    }
    
    function hideHistory() {
      document.getElementById('historyModal').classList.remove('show');
    }
    
    function showSettings() {
      document.getElementById('settingsPanel').classList.add('show');
    }
    
    function hideSettings() {
      document.getElementById('settingsPanel').classList.remove('show');
    }
    
    // å¯åŠ¨
    init();
  </script>
</body>
</html>
