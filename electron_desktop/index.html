<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <title>OpenClaw å®¶åº­åŠ©æ‰‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 90%;
      max-width: 600px;
      height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header p {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .message-area {
      flex: 1;
      background: #f9f9f9;
      padding: 20px;
      overflow-y: auto;
    }
    
    .message {
      margin-bottom: 15px;
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 80%;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .message.user {
      background: #667eea;
      color: white;
      margin-left: auto;
      text-align: right;
    }
    
    .message.assistant {
      background: #f0f0f0;
      color: #333;
    }
    
    .controls {
      padding: 20px;
      background: white;
      border-top: 1px solid #e0e0e0;
      display: flex;
      gap: 10px;
    }
    
    button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .input-area {
      padding: 0 20px 20px;
      background: white;
      display: flex;
      gap: 10px;
    }
    
    input[type="text"] {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      outline: none;
    }
    
    input[type="text"]:focus {
      border-color: #667eea;
    }
    
    .send-btn {
      padding: 12px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .send-btn:hover {
      background: #5568d3;
    }
    
    .status-bar {
      background: #f5f5f5;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: #666;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
    }
    
    .status-indicator.connected {
      background: #4CAF50;
    }
    
    .settings-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .settings-panel.show {
      display: flex;
    }
    
    .settings-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 400px;
    }
    
    .settings-content h2 {
      margin-bottom: 20px;
      color: #333;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #666;
      font-size: 14px;
    }
    
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .settings-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .settings-actions button {
      flex: 1;
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ¤– OpenClaw å®¶åº­åŠ©æ‰‹</h1>
      <p>æ¡Œé¢å®¢æˆ·ç«¯</p>
    </div>
    
    <div class="status-bar">
      <div class="status-indicator" id="statusIndicator"></div>
      <span id="statusText">æœªè¿æ¥</span>
      <span style="margin-left: auto; cursor: pointer; color: #667eea;" onclick="showSettings()">âš™ï¸ è®¾ç½®</span>
    </div>
    
    <div class="message-area" id="messageArea">
      <div class="message assistant">
        ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å®¶åº­åŠ©æ‰‹ã€‚è¾“å…¥æ–‡å­—æˆ–æŒ‰ F2 å¼€å§‹è¯­éŸ³è¾“å…¥ã€‚
      </div>
    </div>
    
    <div class="input-area">
      <input type="text" id="textInput" placeholder="è¾“å…¥æ¶ˆæ¯..." />
      <button class="send-btn" onclick="sendMessage()">å‘é€</button>
    </div>
    
    <div class="controls">
      <button class="btn-primary" id="voiceBtn">ğŸ¤ è¯­éŸ³è¾“å…¥ (F2)</button>
    </div>
  </div>
  
  <!-- è®¾ç½®é¢æ¿ -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-content">
      <h2>âš™ï¸ è®¾ç½®</h2>
      <div class="form-group">
        <label>DashScope API Key:</label>
        <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ API å¯†é’¥" />
      </div>
      <div class="settings-actions">
        <button class="btn-secondary" onclick="hideSettings()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="saveSettings()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    let apiKey = localStorage.getItem('dashscope_api_key') || '';
    let isListening = false;
    let recognition = null;
    
    // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'zh-CN';
      recognition.continuous = false;
      
      recognition.onstart = () => {
        isListening = true;
        document.getElementById('voiceBtn').textContent = 'â¹ï¸ åœæ­¢å½•éŸ³';
        document.getElementById('statusIndicator').className = 'status-indicator connected';
        document.getElementById('statusText').textContent = 'æ­£åœ¨å¬...';
      };
      
      recognition.onend = () => {
        isListening = false;
        document.getElementById('voiceBtn').textContent = 'ğŸ¤ è¯­éŸ³è¾“å…¥ (F2)';
        updateStatus(false, 'å·²è¿æ¥');
      };
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        sendMessage(transcript);
      };
      
      recognition.onerror = (event) => {
        addMessage('è¯­éŸ³è¯†åˆ«é”™è¯¯ï¼š' + event.error, 'error');
      };
    }
    
    // å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if (e.key === 'F2' && !e.ctrlKey && !e.altKey && !e.metaKey) {
        e.preventDefault();
        toggleVoice();
      }
      if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    function updateStatus(connected, text) {
      const indicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');
      
      if (connected) {
        indicator.className = 'status-indicator connected';
      } else {
        indicator.className = 'status-indicator';
      }
      statusText.textContent = text;
    }
    
    function addMessage(text, type = 'assistant') {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.textContent = text;
      const area = document.getElementById('messageArea');
      area.appendChild(msg);
      area.scrollTop = area.scrollHeight;
    }
    
    function sendMessage(text) {
      const input = document.getElementById('textInput');
      const message = text || input.value.trim();
      
      if (!message) return;
      
      addMessage(message, 'user');
      input.value = '';
      
      // è°ƒç”¨ API
      callDashScopeAPI(message);
    }
    
    async function callDashScopeAPI(text) {
      if (!apiKey) {
        addMessage('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API å¯†é’¥', 'error');
        return;
      }
      
      try {
        const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'qwen-max',
            input: {
              messages: [
                { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªå®¶åº­åŠ©æ‰‹ï¼Œè¯·ç†è§£ç”¨æˆ·çš„è¯­éŸ³æŒ‡ä»¤å¹¶æä¾›ç›¸åº”çš„å¸®åŠ©ã€‚' },
                { role: 'user', content: text }
              ]
            },
            parameters: {
              temperature: 0.7,
              top_p: 0.8,
              max_tokens: 500
            }
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.output && data.output.choices && data.output.choices[0]) {
          addMessage(data.output.choices[0].message.content, 'assistant');
        } else {
          addMessage('API é”™è¯¯ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (e) {
        addMessage('è¯·æ±‚å¤±è´¥ï¼š' + e.message, 'error');
      }
    }
    
    function toggleVoice() {
      if (!recognition) {
        addMessage('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«', 'error');
        return;
      }
      
      if (isListening) {
        recognition.stop();
      } else {
        recognition.start();
      }
    }
    
    document.getElementById('voiceBtn').addEventListener('click', toggleVoice);
    document.getElementById('textInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    
    function showSettings() {
      document.getElementById('settingsPanel').classList.add('show');
      document.getElementById('apiKey').value = apiKey;
    }
    
    function hideSettings() {
      document.getElementById('settingsPanel').classList.remove('show');
    }
    
    function saveSettings() {
      apiKey = document.getElementById('apiKey').value.trim();
      localStorage.setItem('dashscope_api_key', apiKey);
      hideSettings();
      addMessage('è®¾ç½®å·²ä¿å­˜', 'assistant');
      updateStatus(true, 'å·²è¿æ¥');
    }
    
    // åˆå§‹åŒ–çŠ¶æ€
    if (apiKey) {
      updateStatus(true, 'å·²è¿æ¥');
    }
  </script>
</body>
</html>
