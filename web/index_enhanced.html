<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw å®¶åº­åŠ©æ‰‹ - å¢å¼ºç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 700px;
            width: 100%;
            height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 24px; }
        .header-actions { display: flex; gap: 10px; }
        .header-actions button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .message-area {
            flex: 1;
            background: #f9f9f9;
            padding: 20px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .message.assistant {
            background: #f0f0f0;
            color: #333;
        }
        .message.error {
            background: #ffebee;
            color: #c62828;
        }
        .message .timestamp {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 5px;
        }
        .controls {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        .controls button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-voice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-voice.listening {
            background: #f44336;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .btn-tts { background: #4CAF50; color: white; }
        .btn-history { background: #2196F3; color: white; }
        .input-area {
            padding: 0 20px 20px;
            background: white;
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
        }
        input[type="text"]:focus { border-color: #667eea; }
        .send-btn {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { color: #333; }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
        }
        .history-item:hover { background: #f5f5f5; }
        .history-item .date { font-size: 12px; color: #666; }
        .history-item .preview { font-size: 14px; margin-top: 5px; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .tts-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        .tts-controls button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– OpenClaw å®¶åº­åŠ©æ‰‹</h1>
            <div class="header-actions">
                <button onclick="showHistory()">ğŸ“œ å†å²</button>
                <button onclick="showSettings()">âš™ï¸ è®¾ç½®</button>
            </div>
        </div>
        
        <div class="message-area" id="messageArea"></div>
        
        <div class="controls">
            <button class="btn-voice" id="voiceBtn" onclick="toggleVoice()">ğŸ¤ è¯­éŸ³è¾“å…¥</button>
            <button class="btn-tts" onclick="toggleTTS()">ğŸ”Š TTS: <span id="ttsStatus">å…³</span></button>
            <button class="btn-history" onclick="clearChat()">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
        
        <div class="input-area">
            <input type="text" id="textInput" placeholder="è¾“å…¥æ¶ˆæ¯... (Ctrl+Enter å‘é€)" />
            <button class="send-btn" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>
    
    <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“œ å¯¹è¯å†å²</h2>
                <button class="close-btn" onclick="hideHistory()">Ã—</button>
            </div>
            <div id="historyList"></div>
        </div>
    </div>
    
    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ è®¾ç½®</h2>
                <button class="close-btn" onclick="hideSettings()">Ã—</button>
            </div>
            <div class="form-group">
                <label>DashScope API Key:</label>
                <input type="password" id="apiKey" placeholder="è¾“å…¥ API å¯†é’¥" />
            </div>
            <div class="form-group">
                <label>å¯¹è¯ä¸Šä¸‹æ–‡é•¿åº¦:</label>
                <select id="contextLength">
                    <option value="5">æœ€è¿‘ 5 æ¡</option>
                    <option value="10" selected>æœ€è¿‘ 10 æ¡</option>
                    <option value="20">æœ€è¿‘ 20 æ¡</option>
                </select>
            </div>
            <div class="form-group">
                <label>TTS è¯­éŸ³:</label>
                <select id="ttsVoice">
                    <option value="zh-CN">ä¸­æ–‡</option>
                    <option value="en-US">English</option>
                </select>
            </div>
            <button class="send-btn" style="width:100%" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <script>
        // çŠ¶æ€ç®¡ç†
        const state = {
            apiKey: localStorage.getItem('dashscope_api_key') || '',
            contextLength: parseInt(localStorage.getItem('context_length') || '10'),
            ttsEnabled: localStorage.getItem('tts_enabled') === 'true',
            ttsVoice: localStorage.getItem('tts_voice') || 'zh-CN',
            messages: JSON.parse(localStorage.getItem('chat_history') || '[]'),
            conversationHistory: [],
            isListening: false,
            recognition: null,
            synth: window.speechSynthesis
        };

        // åˆå§‹åŒ–
        function init() {
            document.getElementById('apiKey').value = state.apiKey;
            document.getElementById('contextLength').value = state.contextLength;
            document.getElementById('ttsVoice').value = state.ttsVoice;
            updateTTSStatus();
            setupSpeechRecognition();
            loadMessages();
            
            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                if (e.key === 'F2' && !e.ctrlKey) {
                    e.preventDefault();
                    toggleVoice();
                }
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // è¯­éŸ³è¯†åˆ«
        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                state.recognition = new SpeechRecognition();
                state.recognition.lang = 'zh-CN';
                state.recognition.continuous = false;
                
                state.recognition.onstart = () => {
                    state.isListening = true;
                    document.getElementById('voiceBtn').textContent = 'â¹ï¸ åœæ­¢å½•éŸ³';
                    document.getElementById('voiceBtn').classList.add('listening');
                };
                
                state.recognition.onend = () => {
                    state.isListening = false;
                    document.getElementById('voiceBtn').textContent = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
                    document.getElementById('voiceBtn').classList.remove('listening');
                };
                
                state.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    sendMessage(transcript);
                };
                
                state.recognition.onerror = (event) => {
                    addMessage('è¯­éŸ³è¯†åˆ«é”™è¯¯ï¼š' + event.error, 'error');
                };
            }
        }

        function toggleVoice() {
            if (!state.recognition) {
                addMessage('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«', 'error');
                return;
            }
            if (state.isListening) {
                state.recognition.stop();
            } else {
                state.recognition.start();
            }
        }

        // å‘é€æ¶ˆæ¯ï¼ˆå¸¦å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ï¼‰
        function sendMessage(text) {
            const input = document.getElementById('textInput');
            const message = text || input.value.trim();
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            // æ›´æ–°å¯¹è¯å†å²
            state.conversationHistory.push({ role: 'user', content: message });
            if (state.conversationHistory.length > state.contextLength * 2) {
                state.conversationHistory = state.conversationHistory.slice(-state.contextLength * 2);
            }
            
            callDashScopeAPI(message);
        }

        // è°ƒç”¨ APIï¼ˆå¸¦ä¸Šä¸‹æ–‡ï¼‰
        async function callDashScopeAPI(userMessage) {
            if (!state.apiKey) {
                addMessage('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API å¯†é’¥', 'error');
                return;
            }
            
            const loadingId = addMessage('æ€è€ƒä¸­...', 'assistant');
            
            try {
                const messages = [
                    { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªå®¶åº­åŠ©æ‰‹ï¼Œè¯·ç†è§£ç”¨æˆ·çš„è¯­éŸ³æŒ‡ä»¤å¹¶æä¾›ç›¸åº”çš„å¸®åŠ©ã€‚ä¿æŒå¯¹è¯è¿è´¯æ€§ã€‚' },
                    ...state.conversationHistory
                ];
                
                const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'qwen-max',
                        input: { messages },
                        parameters: {
                            temperature: 0.7,
                            top_p: 0.8,
                            max_tokens: 500
                        }
                    })
                });
                
                removeMessage(loadingId);
                const data = await response.json();
                
                if (response.ok && data.output && data.output.choices && data.output.choices[0]) {
                    const content = data.output.choices[0].message.content;
                    addMessage(content, 'assistant');
                    
                    // æ›´æ–°å¯¹è¯å†å²
                    state.conversationHistory.push({ role: 'assistant', content });
                    
                    // TTS æœ—è¯»
                    if (state.ttsEnabled) {
                        speak(content);
                    }
                } else {
                    addMessage('API é”™è¯¯ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                removeMessage(loadingId);
                addMessage('è¯·æ±‚å¤±è´¥ï¼š' + e.message, 'error');
            }
            
            saveMessages();
        }

        // TTS è¯­éŸ³åˆæˆ
        function speak(text) {
            if (!state.synth) return;
            
            state.synth.cancel(); // åœæ­¢å½“å‰æœ—è¯»
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = state.ttsVoice;
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            state.synth.speak(utterance);
        }

        function toggleTTS() {
            state.ttsEnabled = !state.ttsEnabled;
            localStorage.setItem('tts_enabled', state.ttsEnabled);
            updateTTSStatus();
        }

        function updateTTSStatus() {
            document.getElementById('ttsStatus').textContent = state.ttsEnabled ? 'å¼€' : 'å…³';
        }

        // æ¶ˆæ¯ç®¡ç†
        function addMessage(content, type) {
            const id = 'msg-' + Date.now();
            const msg = {
                id,
                content,
                type,
                timestamp: new Date().toISOString()
            };
            state.messages.push(msg);
            renderMessage(msg);
            saveMessages();
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function renderMessage(msg) {
            const area = document.getElementById('messageArea');
            const div = document.createElement('div');
            div.className = `message ${msg.type}`;
            div.id = msg.id;
            div.innerHTML = `
                ${msg.content}
                <div class="timestamp">${new Date(msg.timestamp).toLocaleString('zh-CN')}</div>
            `;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function loadMessages() {
            const area = document.getElementById('messageArea');
            area.innerHTML = '';
            if (state.messages.length === 0) {
                addMessage('ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„å®¶åº­åŠ©æ‰‹ã€‚æ”¯æŒè¯­éŸ³è¾“å…¥ã€TTS æœ—è¯»ã€å¤šè½®å¯¹è¯å’Œå†å²è®°å½•ã€‚æŒ‰ F2 å¼€å§‹è¯­éŸ³è¾“å…¥ã€‚', 'assistant');
            } else {
                state.messages.forEach(renderMessage);
            }
        }

        function saveMessages() {
            localStorage.setItem('chat_history', JSON.stringify(state.messages));
        }

        function clearChat() {
            if (confirm('ç¡®å®šæ¸…ç©ºå¯¹è¯å†å²ï¼Ÿ')) {
                state.messages = [];
                state.conversationHistory = [];
                saveMessages();
                loadMessages();
            }
        }

        // å†å²è®°å½•
        function showHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            
            // æŒ‰æ—¥æœŸåˆ†ç»„
            const grouped = {};
            state.messages.forEach(msg => {
                const date = new Date(msg.timestamp).toLocaleDateString('zh-CN');
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(msg);
            });
            
            Object.keys(grouped).reverse().forEach(date => {
                const dateDiv = document.createElement('div');
                dateDiv.style.fontWeight = 'bold';
                dateDiv.style.margin = '10px 0 5px';
                dateDiv.textContent = date;
                list.appendChild(dateDiv);
                
                grouped[date].forEach(msg => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div class="date">${new Date(msg.timestamp).toLocaleTimeString('zh-CN')} - ${msg.type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
                        <div class="preview">${msg.content.substring(0, 50)}${msg.content.length > 50 ? '...' : ''}</div>
                    `;
                    list.appendChild(item);
                });
            });
            
            document.getElementById('historyModal').classList.add('show');
        }

        function hideHistory() {
            document.getElementById('historyModal').classList.remove('show');
        }

        // è®¾ç½®
        function showSettings() {
            document.getElementById('settingsModal').classList.add('show');
        }

        function hideSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function saveSettings() {
            state.apiKey = document.getElementById('apiKey').value.trim();
            state.contextLength = parseInt(document.getElementById('contextLength').value);
            state.ttsVoice = document.getElementById('ttsVoice').value;
            
            localStorage.setItem('dashscope_api_key', state.apiKey);
            localStorage.setItem('context_length', state.contextLength);
            localStorage.setItem('tts_voice', state.ttsVoice);
            
            hideSettings();
            addMessage('è®¾ç½®å·²ä¿å­˜', 'assistant');
        }

        // å¯åŠ¨
        init();
    </script>
</body>
</html>
